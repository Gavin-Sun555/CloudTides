/*
 * Copyright (c) 2016-2019 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
import { __decorate, __param } from "tslib";
import { Component, ContentChildren, Optional, ChangeDetectionStrategy, Input, } from '@angular/core';
import { FormGroupDirective, NgForm } from '@angular/forms';
import { startWith, filter } from 'rxjs/operators';
import { StepperService } from './providers/stepper.service';
import { AccordionService } from '../providers/accordion.service';
import { ClrStepperPanel } from './stepper-panel';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/forms';

const _c0 = ["clrStepper", ""];
const _c1 = ["*"];
let ClrStepper = class ClrStepper {
    constructor(formGroup, ngForm, stepperService) {
        this.formGroup = formGroup;
        this.ngForm = ngForm;
        this.stepperService = stepperService;
        this.subscriptions = [];
    }
    ngOnInit() {
        if (!this.formGroup && !this.ngForm) {
            throw new Error('To use stepper a Reactive or Template Form is required.');
        }
        this.form = this.formGroup ? this.formGroup : this.ngForm;
        this.subscriptions.push(this.listenForPanelsCompleted());
        this.subscriptions.push(this.listenForFormResetChanges());
    }
    ngOnChanges(changes) {
        if (changes.initialPanel.currentValue !== changes.initialPanel.previousValue) {
            this.stepperService.overrideInitialPanel(this.initialPanel);
        }
    }
    ngAfterViewInit() {
        this.subscriptions.push(this.listenForDOMChanges());
    }
    ngOnDestroy() {
        this.subscriptions.forEach(s => s.unsubscribe());
    }
    listenForFormResetChanges() {
        return this.form.statusChanges
            .pipe(filter(() => this.form.pristine)) // https://github.com/angular/angular/issues/10887
            .subscribe(() => this.stepperService.resetPanels());
    }
    listenForPanelsCompleted() {
        return this.stepperService.panelsCompleted.subscribe(panelsCompleted => {
            if (panelsCompleted && this.form.valid) {
                this.form.ngSubmit.emit();
            }
            else if (!this.form.valid && this.form.touched) {
                this.setPanelsWithFormErrors();
            }
        });
    }
    setPanelsWithFormErrors() {
        const panelsWithErrors = this.panels.reduce((panels, p) => (p.formGroup.invalid ? [...panels, p.id] : panels), []);
        this.stepperService.setPanelsWithErrors(panelsWithErrors);
    }
    listenForDOMChanges() {
        return this.panels.changes.pipe(startWith(this.panels)).subscribe(panels => {
            this.stepperService.updatePanelOrder(panels.toArray().map(p => p.id));
            if (this.initialPanel) {
                this.stepperService.overrideInitialPanel(this.initialPanel);
            }
        });
    }
};
ClrStepper.ɵfac = function ClrStepper_Factory(t) { return new (t || ClrStepper)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.FormGroupDirective, 8), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.NgForm, 8), ɵngcc0.ɵɵdirectiveInject(StepperService)); };
ClrStepper.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: ClrStepper, selectors: [["form", "clrStepper", ""]], contentQueries: function ClrStepper_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, ClrStepperPanel, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.panels = _t);
    } }, hostVars: 4, hostBindings: function ClrStepper_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("clr-accordion", true)("clr-stepper-forms", true);
    } }, inputs: { initialPanel: ["clrInitialStep", "initialPanel"] }, features: [ɵngcc0.ɵɵProvidersFeature([StepperService, { provide: AccordionService, useExisting: StepperService }]), ɵngcc0.ɵɵNgOnChangesFeature], attrs: _c0, ngContentSelectors: _c1, decls: 1, vars: 0, template: function ClrStepper_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, encapsulation: 2, changeDetection: 0 });
ClrStepper.ctorParameters = () => [
    { type: FormGroupDirective, decorators: [{ type: Optional }] },
    { type: NgForm, decorators: [{ type: Optional }] },
    { type: StepperService }
];
__decorate([
    Input('clrInitialStep')
], ClrStepper.prototype, "initialPanel", void 0);
__decorate([
    ContentChildren(ClrStepperPanel, { descendants: true })
], ClrStepper.prototype, "panels", void 0);
ClrStepper = __decorate([ __param(0, Optional()),
    __param(1, Optional())
], ClrStepper);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ClrStepper, [{
        type: Component,
        args: [{
                selector: 'form[clrStepper]',
                template: `<ng-content></ng-content>`,
                host: {
                    '[class.clr-accordion]': 'true',
                    '[class.clr-stepper-forms]': 'true'
                },
                providers: [StepperService, { provide: AccordionService, useExisting: StepperService }],
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: ɵngcc1.FormGroupDirective, decorators: [{
                type: Optional
            }] }, { type: ɵngcc1.NgForm, decorators: [{
                type: Optional
            }] }, { type: StepperService }]; }, { initialPanel: [{
            type: Input,
            args: ['clrInitialStep']
        }], panels: [{
            type: ContentChildren,
            args: [ClrStepperPanel, { descendants: true }]
        }] }); })();
export { ClrStepper };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci5qcyIsInNvdXJjZXMiOlsibmc6L0BjbHIvYW5ndWxhci9hY2NvcmRpb24vc3RlcHBlci9zdGVwcGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsT0FBTyxFQUNMLFNBQVMsRUFDVCxlQUFlLEVBRWYsUUFBUSxFQUNSLHVCQUF1QixFQUN2QixLQUFLLEdBTU4sTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7O0FBWWxELElBQWEsVUFBVSxHQUF2QixNQUFhLFVBQVU7QUFBRyxJQU94QixZQUNzQixTQUE2QixFQUM3QixNQUFjLEVBQzFCLGNBQThCO0FBQ3ZDLFFBSHFCLGNBQVMsR0FBVCxTQUFTLENBQW9CO0FBQUMsUUFDOUIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQzNCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtBQUMxQyxRQVBFLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztBQUNyQyxJQU1LLENBQUM7QUFDTixJQUNFLFFBQVE7QUFDVixRQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtBQUN6QyxZQUFNLE1BQU0sSUFBSSxLQUFLLENBQUMseURBQXlELENBQUMsQ0FBQztBQUNqRixTQUFLO0FBQ0wsUUFDSSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDOUQsUUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO0FBQzdELFFBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUMsQ0FBQztBQUM5RCxJQUFFLENBQUM7QUFDSCxJQUNFLFdBQVcsQ0FBQyxPQUFzQjtBQUNwQyxRQUFJLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxZQUFZLEtBQUssT0FBTyxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUU7QUFDbEYsWUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNsRSxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDRSxlQUFlO0FBQ2pCLFFBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztBQUN4RCxJQUFFLENBQUM7QUFDSCxJQUNFLFdBQVc7QUFDYixRQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDckQsSUFBRSxDQUFDO0FBQ0gsSUFDVSx5QkFBeUI7QUFDbkMsUUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYTtBQUNsQyxhQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGtEQUFrRDtBQUNoRyxhQUFPLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDMUQsSUFBRSxDQUFDO0FBQ0gsSUFDVSx3QkFBd0I7QUFDbEMsUUFBSSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsRUFBRTtBQUMzRSxZQUFNLElBQUksZUFBZSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO0FBQzlDLGdCQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2xDLGFBQU87QUFBQyxpQkFBSyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7QUFDeEQsZ0JBQVEsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7QUFDdkMsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUFFLENBQUM7QUFDSCxJQUNVLHVCQUF1QjtBQUNqQyxRQUFJLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkgsUUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDOUQsSUFBRSxDQUFDO0FBQ0gsSUFDVSxtQkFBbUI7QUFDN0IsUUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO0FBQy9FLFlBQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDNUUsWUFDTSxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7QUFDN0IsZ0JBQVEsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEUsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUFFLENBQUM7QUFDSCxDQUFDOzs7Ozs7Ozs7Ozs7aURBQUE7QUFDRDtBQUFvQyxZQTVERCxrQkFBa0IsdUJBQWhELFFBQVE7QUFBTyxZQUNZLE1BQU0sdUJBQWpDLFFBQVE7QUFBTyxZQUNRLGNBQWM7QUFDeEM7QUFWeUI7QUFBYSxJQUFyQyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7QUFBQyxnREFBcUI7QUFFOUM7QUFBYSxJQURaLGVBQWUsQ0FBQyxlQUFlLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDMUQsMENBQXFDO0FBSHhCLFVBQVUsb0JBVnRCLFNBQVMsQ0FBQyxmQVVQLENBUUMsV0FBQSxRQUFRLEVBQUUsQ0FBQTtBQWpCYixRQUFRLEVBQUUsVkFpQkssSUFDWixXQUFBLFFBQVEsRUFBRSxDQUFBO0NBbEJlLFVBQzVCLFhBaUJjLEdBVEgsVUFBVSxDQW1FdEI7R0EzRVMsRUFBRSwyQkFBMkIsVUFDckMsSUFBSSxFQUFFLGNBQ0o7Z0JBQXVCLEVBQUUsTUFBTTthQUMvQjt1QkFBMkIsRUFBRSxNQUFNLFdBQ3BDO01BQ0QsU0FBUyxFQUFFLENBQUMsY0FBYyxFQUFFLEVBQUUsT0FBTyxFQUFFO01BQWdCLEVBQUUsV0FBVyxFQUFFO1dBQWMsRUFBRSxDQUFDLFVBQ3ZGLGVBQWUsRUFBRTtXQUF1QixDQUFDLE1BQU0sTUFDaEQsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7O29CQXFFRjtBQUFDLFNBcEVZLFVBQVU7QUFBSSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTYtMjAxOSBWTXdhcmUsIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIFRoaXMgc29mdHdhcmUgaXMgcmVsZWFzZWQgdW5kZXIgTUlUIGxpY2Vuc2UuXG4gKiBUaGUgZnVsbCBsaWNlbnNlIGluZm9ybWF0aW9uIGNhbiBiZSBmb3VuZCBpbiBMSUNFTlNFIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHByb2plY3QuXG4gKi9cblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIFF1ZXJ5TGlzdCxcbiAgT3B0aW9uYWwsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBJbnB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBBZnRlclZpZXdJbml0LFxuICBPbkRlc3Ryb3ksXG4gIE9uQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtR3JvdXBEaXJlY3RpdmUsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IHN0YXJ0V2l0aCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IFN0ZXBwZXJTZXJ2aWNlIH0gZnJvbSAnLi9wcm92aWRlcnMvc3RlcHBlci5zZXJ2aWNlJztcbmltcG9ydCB7IEFjY29yZGlvblNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvYWNjb3JkaW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2xyU3RlcHBlclBhbmVsIH0gZnJvbSAnLi9zdGVwcGVyLXBhbmVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZm9ybVtjbHJTdGVwcGVyXScsXG4gIHRlbXBsYXRlOiBgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PmAsXG4gIGhvc3Q6IHtcbiAgICAnW2NsYXNzLmNsci1hY2NvcmRpb25dJzogJ3RydWUnLFxuICAgICdbY2xhc3MuY2xyLXN0ZXBwZXItZm9ybXNdJzogJ3RydWUnLFxuICB9LFxuICBwcm92aWRlcnM6IFtTdGVwcGVyU2VydmljZSwgeyBwcm92aWRlOiBBY2NvcmRpb25TZXJ2aWNlLCB1c2VFeGlzdGluZzogU3RlcHBlclNlcnZpY2UgfV0sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBDbHJTdGVwcGVyIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgnY2xySW5pdGlhbFN0ZXAnKSBpbml0aWFsUGFuZWw6IHN0cmluZztcbiAgQENvbnRlbnRDaGlsZHJlbihDbHJTdGVwcGVyUGFuZWwsIHsgZGVzY2VuZGFudHM6IHRydWUgfSlcbiAgcGFuZWxzOiBRdWVyeUxpc3Q8Q2xyU3RlcHBlclBhbmVsPjtcbiAgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcbiAgZm9ybTogRm9ybUdyb3VwRGlyZWN0aXZlIHwgTmdGb3JtO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZm9ybUdyb3VwOiBGb3JtR3JvdXBEaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBuZ0Zvcm06IE5nRm9ybSxcbiAgICBwcml2YXRlIHN0ZXBwZXJTZXJ2aWNlOiBTdGVwcGVyU2VydmljZVxuICApIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKCF0aGlzLmZvcm1Hcm91cCAmJiAhdGhpcy5uZ0Zvcm0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVG8gdXNlIHN0ZXBwZXIgYSBSZWFjdGl2ZSBvciBUZW1wbGF0ZSBGb3JtIGlzIHJlcXVpcmVkLicpO1xuICAgIH1cblxuICAgIHRoaXMuZm9ybSA9IHRoaXMuZm9ybUdyb3VwID8gdGhpcy5mb3JtR3JvdXAgOiB0aGlzLm5nRm9ybTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmxpc3RlbkZvclBhbmVsc0NvbXBsZXRlZCgpKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmxpc3RlbkZvckZvcm1SZXNldENoYW5nZXMoKSk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuaW5pdGlhbFBhbmVsLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5pbml0aWFsUGFuZWwucHJldmlvdXNWYWx1ZSkge1xuICAgICAgdGhpcy5zdGVwcGVyU2VydmljZS5vdmVycmlkZUluaXRpYWxQYW5lbCh0aGlzLmluaXRpYWxQYW5lbCk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMubGlzdGVuRm9yRE9NQ2hhbmdlcygpKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHMgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgfVxuXG4gIHByaXZhdGUgbGlzdGVuRm9yRm9ybVJlc2V0Q2hhbmdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtLnN0YXR1c0NoYW5nZXNcbiAgICAgIC5waXBlKGZpbHRlcigoKSA9PiB0aGlzLmZvcm0ucHJpc3RpbmUpKSAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8xMDg4N1xuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnN0ZXBwZXJTZXJ2aWNlLnJlc2V0UGFuZWxzKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5Gb3JQYW5lbHNDb21wbGV0ZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RlcHBlclNlcnZpY2UucGFuZWxzQ29tcGxldGVkLnN1YnNjcmliZShwYW5lbHNDb21wbGV0ZWQgPT4ge1xuICAgICAgaWYgKHBhbmVsc0NvbXBsZXRlZCAmJiB0aGlzLmZvcm0udmFsaWQpIHtcbiAgICAgICAgdGhpcy5mb3JtLm5nU3VibWl0LmVtaXQoKTtcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuZm9ybS52YWxpZCAmJiB0aGlzLmZvcm0udG91Y2hlZCkge1xuICAgICAgICB0aGlzLnNldFBhbmVsc1dpdGhGb3JtRXJyb3JzKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldFBhbmVsc1dpdGhGb3JtRXJyb3JzKCkge1xuICAgIGNvbnN0IHBhbmVsc1dpdGhFcnJvcnMgPSB0aGlzLnBhbmVscy5yZWR1Y2UoKHBhbmVscywgcCkgPT4gKHAuZm9ybUdyb3VwLmludmFsaWQgPyBbLi4ucGFuZWxzLCBwLmlkXSA6IHBhbmVscyksIFtdKTtcbiAgICB0aGlzLnN0ZXBwZXJTZXJ2aWNlLnNldFBhbmVsc1dpdGhFcnJvcnMocGFuZWxzV2l0aEVycm9ycyk7XG4gIH1cblxuICBwcml2YXRlIGxpc3RlbkZvckRPTUNoYW5nZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFuZWxzLmNoYW5nZXMucGlwZShzdGFydFdpdGgodGhpcy5wYW5lbHMpKS5zdWJzY3JpYmUocGFuZWxzID0+IHtcbiAgICAgIHRoaXMuc3RlcHBlclNlcnZpY2UudXBkYXRlUGFuZWxPcmRlcihwYW5lbHMudG9BcnJheSgpLm1hcChwID0+IHAuaWQpKTtcblxuICAgICAgaWYgKHRoaXMuaW5pdGlhbFBhbmVsKSB7XG4gICAgICAgIHRoaXMuc3RlcHBlclNlcnZpY2Uub3ZlcnJpZGVJbml0aWFsUGFuZWwodGhpcy5pbml0aWFsUGFuZWwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=